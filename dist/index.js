"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("gm"),e=require("path"),i=require("fs-extra"),s=require("stream");function a(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=a(t),n=a(e),o=a(i);const h={quality:0,format:"png",width:768,height:512,density:72,savePath:"./",saveFilename:"untitled",compression:"jpeg"};class u{constructor(){this.quality=0,this.format="png",this.width=768,this.height=512,this.density=72,this.savePath="./",this.saveFilename="untitled",this.compression="jpeg",this.gm=r.default.subClass({imageMagick:!1}),this.gmClass={imageMagick:!1}}generateValidFilename(t){return"number"==typeof t?`${this.savePath}/${this.saveFilename}.${t+1}.${this.format}`:`${this.savePath}/${this.saveFilename}.${this.format}`}gmBaseCommand(t,e){return this.gm(t,e).density(this.density,this.density).resize(this.width).quality(this.quality).compress(this.compression)}toBase64(t,e){const i=`${t.path}[${e}]`;return new Promise(((s,a)=>{this.gmBaseCommand(t,i).stream(this.format,((t,i)=>{let r="";if(t)return a(t);i.on("data",(t=>{r+=t.toString("binary")})).on("end",(()=>{const t=Buffer.from(r,"binary").toString("base64");return s({base64:t,size:`${this.width}x${this.height}`,page:e+1})}))}))}))}writeImage(t,e){const i=this.generateValidFilename(e),s=`${t.path}[${e}]`;return new Promise(((a,r)=>{this.gmBaseCommand(t,s).write(i,(t=>t?r(t):a({name:n.default.basename(i),size:`${this.width}x${this.height}`,fileSize:o.default.statSync(i).size/1e3,path:i,page:e+1})))}))}identify(t,e){const i=this.gm(t);return new Promise(((t,s)=>{e?i.identify(e,((e,i)=>e?s(e):t(i.replace(/^[\w\W]*?1/,"1")))):i.identify(((e,i)=>e?s(e):t(i)))}))}setQuality(t){return this.quality=t,this}setFormat(t){return this.format=t,this}setSize(t,e){return this.width=t,this.height=e||t,this}setDensity(t){return this.density=t,this}setSavePath(t){return this.savePath=t,this}setSaveFilename(t){return this.saveFilename=t,this}setCompression(t){return this.compression=t,this}setGMClass(t){return"boolean"==typeof t?(this.gm=r.default.subClass({imageMagick:t}),this.gmClass={imageMagick:t},this):"imagemagick"===t.toLocaleLowerCase()?(this.gm=r.default.subClass({imageMagick:!0}),this):(this.gm=r.default.subClass({appPath:t}),this)}getOptions(){return{quality:this.quality,format:this.format,width:this.width,height:this.height,density:this.density,savePath:this.savePath,saveFilename:this.saveFilename,compression:this.compression}}}function m(t){return new s.Readable({read(){this.push(t),this.push(null)}})}function l(t,e){if("buffer"===t)return m(e);if("path"===t)return i.createReadStream(e);if("base64"===t)return s=e,m(Buffer.from(s,"base64"));var s;throw new Error("Cannot recognize specified source")}function f(t,e,i,s){return new(i||(i=Promise))((function(a,r){function n(t){try{h(s.next(t))}catch(t){r(t)}}function o(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?a(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(n,o)}h((s=s.apply(t,e||[])).next())}))}function c(t,e,i,s=1,a=!1){return f(this,void 0,void 0,(function*(){if(-1!==s&&s<1)throw new Error("Page number should be more than or equal 1");const r=l(e,i),n=l(e,i),o=Array.isArray(s)?s:[s],h=(s=-1===s?yield((t,e,i)=>f(this,void 0,void 0,(function*(){const s=yield function(t,e){return f(this,void 0,void 0,(function*(){return(yield t.identify(e,"%p ")).split(" ").map((t=>parseInt(t,10)))}))}(t,e);return 1===s.length&&0===s[0]?[1]:i?s.concat(s[s.length-1]+1):s})))(t,n,t.gmClass.imageMagick):o).map((e=>{if(s<1)throw new Error("Page number should be more than or equal 1");return a?t.toBase64(r,e-1):t.writeImage(r,e-1)}));return Promise.all(h)}))}function d(t,e,i=h){const s=new u;i=Object.assign(Object.assign({},h),i);const a=(i=1,a=!1)=>{if(i<1)throw new Error("Page number should be more than or equal 1");const r=l(t,e);return a?s.toBase64(r,i-1):s.writeImage(r,i-1)};return a.bulk=(i,a=!1)=>c(s,t,e,i,a),a.setOptions=()=>function(t,e){return void t.setQuality(e.quality).setFormat(e.format).setSize(e.width,e.height).setDensity(e.density).setSavePath(e.savePath).setSaveFilename(e.saveFilename).setCompression(e.compression)}(s,i),a.setGMClass=t=>{s.setGMClass(t)},a.setOptions(),a}exports.fromBase64=function(t,e=h){return d("base64",t,e)},exports.fromBuffer=function(t,e=h){return d("buffer",t,e)},exports.fromPath=function(t,e=h){return d("path",t,e)};
